<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>Multi-Petabyte Data Distribution in Industry & Science with CernVM File System</title>

		<link rel="stylesheet" href="dist/reset.css">
		<link rel="stylesheet" href="dist/reveal.css">
		<link rel="stylesheet" href="dist/theme/white-fosdem-ish.css">
		<link rel="stylesheet" type="text/css" href="css/asciinema-player.css" />

		<!-- Theme used for syntax highlighted code -->
		<link rel="stylesheet" href="plugin/highlight/monokai.css">
	</head>
	<body>
		<div class="reveal">
			<div class="slides">
				<section data-markdown>
					<textarea data-template>
					<img src="assets/img/fosdem-gear.svg">

					Multi-Petabyte Data Distribution in Industry & Science with CernVM File System

					<ul style="list-style-type: none;">
						<li>Georgios Christodoulis, CERN</li>
						<li>Andriy Utkin</li>
					</ul>
					</textarea>
				</section>

				<section data-markdown>
					<textarea data-template>
						# Fill in

						Contents go there
					</textarea>
				</section>

				<section data-markdown  data-background-image="./assets/img/bottle.png" data-background-opacity="1">
					<textarea data-template>
						<aside class="notes">
							5 seconds pause to let viewers appreciate the picture.

							Move on.
						</aside>
					</textarea>
				</section>

				<section data-markdown  data-background-image="./assets/img/bottle.png" data-background-opacity="0.1">
					<textarea data-template>
					## cvmfs-posix-tools

					<aside class="notes">
						These are new tools, modelled after popular file utilities, which offer the convenience of direct effect on CVMFS repo.
						With big uploads, performance will also be better.

						I believe availability of such commands will make CVMFS administration more attractive to potential adopters.
					</aside>

					<!-- Deemphasize common prefix, emphasize second half of command names -->
					<ul style="columns: 2; list-style-type: none;">
						<li>cvmfs_<strong>chgrp</strong></li>
						<li>cvmfs_<strong>chmod</strong></li>
						<li>cvmfs_<strong>chown</strong></li>
						<li>cvmfs_<strong>insert</strong></li>
						<li>cvmfs_<strong>ln</strong></li>
						<li>cvmfs_<strong>mkdir</strong></li>
						<li>cvmfs_<strong>rm</strong></li>
						<li>cvmfs_<strong>rmdir</strong></li>
						<li>cvmfs_<strong>rsync</strong></li>
						<li>cvmfs_<strong>setfacl</strong></li>
						<li>cvmfs_<strong>touch</strong></li>
					</ul>

					</textarea>
				</section>
				<section data-markdown>
					<textarea data-template>
						## Changing contents, the usual way


						The usual method:
						* `cvmfs_server transaction`
						* make changes
						* `cvmfs_server publish`

						<aside class="notes">
							To explain why they are needed, let's briefly see how changing contents <strong>currently</strong> works from the user perspective.

							The first method you learn from the documentation to change the contents of your repo is this:

							* `cvmfs_server transaction`
							* make changes
							* `cvmfs_server publish`

						</aside>
					</textarea>
				</section>

				<section>
					<aside class="notes">
						This embedded asciinema player is local.
					</aside>
					<iframe src='publish-demo.html'
							width="100%"
							height="100%"
							style=" width:100%; height:100vh; overflow:hidden; margin:0px; padding:0px; border:none;"
						>
					</iframe>
				</section>

				<!--
				<section>
					<aside class="notes">
						This embedded asciinema player requires Internet connection.
					</aside>
					<script src="https://asciinema.org/a/ykcHljeTTw4cLKE5.js" id="asciicast-ykcHljeTTw4cLKE5" async="true"></script>
				</section>
				-->

				<!--
				<section>
					<aside class="notes">
						This embedded asciinema player is local but plays irksomely when red selections appear.
					</aside>
					<iframe src='about:blank'>
					<div
					class="asciinema"
					file="./assets/publish-demo.asciicast"
					style="width: 900px; height: 400px;"
					></div>
				</section>
				-->

				<!--
				<section data-markdown>
					<textarea data-template>
					<h2>cvmfs_server transaction/publish: under the hood</h2>

					This works as follows:

					`cvmfs_server transaction`:

					- overlayfs mount is changed from read-only to read-write

					from this:
					<pre><code data-trim data-noescape class="weird-code no-highlight">
					my.repo on /var/spool/cvmfs/my.repo/rdonly type fuse (<span style="color:red">ro</span>,nodev,relatime,user_id=0,group_id=0,default_permissions,allow_other)
					overlay_my.repo on /cvmfs/my.repo type overlay (<span style="color:red">ro</span>,nodev,relatime,lowerdir=/var/spool/cvmfs/my.repo/rdonly,upperdir=/var/spool/cvmfs/my.repo/scratch/current,workdir=/var/spool/cvmfs/my.repo/ofs_workdir,uuid=on)
					</code></pre>

					to this:

					<pre><code data-trim data-noescape class="no-highlight">
					my.repo on /var/spool/cvmfs/my.repo/rdonly type fuse (<span style="color:red">ro</span>,nodev,relatime,user_id=0,group_id=0,default_permissions,allow_other)
					overlay_my.repo on /cvmfs/my.repo type overlay (<span style="color:red">rw</span>,relatime,lowerdir=/var/spool/cvmfs/my.repo/rdonly,upperdir=/var/spool/cvmfs/my.repo/scratch/current,workdir=/var/spool/cvmfs/my.repo/ofs_workdir,uuid=on)
					</code></pre>

					</textarea>
				</section>
				-->
				<section data-markdown>
					<textarea data-template>
					<h2>cvmfs_server transaction/publish: under the hood</h2>


					`cvmfs_server publish`:

					- looks at overlayfs "scratch area"(?), prepares submission to gateway
					- gateway changes actual authoritative contents and creates a new revision of repo contents
					- DOESNT FIT ON SLIDE! waits until the new revision propagates to the local mountpoint


					</textarea>
				</section>
				<section data-markdown>
					<textarea data-template>
					<h3>cvmfs_server transaction/publish: under the hood</h3>

					* You need disk space in scratch area for overlayfs, all you changes must fit in there.
					* Copying big files into CVMFS takes extra copying.
					</textarea>
				</section>

				<section data-markdown>
					<textarea data-template>
					## cvmfs-posix-tools: under the hood

					- has S3 backed CVMFS repos in mind
					- (no ingestsql specifics here!)

					</textarea>
				</section>

				<!--
				<section>
						<table width="100%" border>
							<tr>
								<td>transaction/publish</td>
								<td>cvmfs-posix-tools</td>
							</tr>
							<tr>
								<td>
									<strong>cvmfs_server transaction</strong> remounts overlayfs

									from this:
									<pre><code data-trim data-noescape class="no-highlight">
									my.repo on /var/spool/cvmfs/my.repo/rdonly type fuse (<span style="color:red">ro</span>,nodev,relatime,user_id=0,group_id=0,default_permissions,allow_other)
									overlay_my.repo on /cvmfs/my.repo type overlay (<span style="color:red">ro</span>,nodev,relatime,lowerdir=/var/spool/cvmfs/my.repo/rdonly,upperdir=/var/spool/cvmfs/my.repo/scratch/current,workdir=/var/spool/cvmfs/my.repo/ofs_workdir,uuid=on)
									</code></pre>

									to this:

									<pre><code data-trim data-noescape class="no-highlight">
									my.repo on /var/spool/cvmfs/my.repo/rdonly type fuse (<span style="color:red">ro</span>,nodev,relatime,user_id=0,group_id=0,default_permissions,allow_other)
									overlay_my.repo on /cvmfs/my.repo type overlay (<span style="color:red">rw</span>,relatime,lowerdir=/var/spool/cvmfs/my.repo/rdonly,upperdir=/var/spool/cvmfs/my.repo/scratch/current,workdir=/var/spool/cvmfs/my.repo/ofs_workdir,uuid=on)
									</code></pre>


								</td>
								<td></td>
							</tr>
							<tr>
								<td><strong>cp</strong>copies files into local scratch area used by overlayfs (tmpfs or not)</td>
								<td></td>
							</tr>
							<tr>
								<td><strong>cvmfs_server publish</strong>
									remounts overlayfs
								</td>
								<td></td>
							</tr>
						</table>
				</section>
				-->

				<section data-markdown>
				</section>

				<section data-markdown>
					<textarea data-template>
					## cvmfs-posix-tools: demo

					- live env on my laptop
					- fallback live env on my server, which I can ssh into if my laptop fails
					- asciinema
					- video recording
					</textarea>
				</section>

				<section data-markdown>
					<textarea data-template>
					## cvmfs-posix-tools: try it out now!

					- podman / docker container

					```
					[docker|podman] run -it docker://docker.io/andreyutkin/cvmfs-fosdem26-demos
					```

					- incus container, VM
					- qcow2 VM image

					</textarea>
				</section>

				<section data-markdown>
					<textarea data-template>
					## Containers images on mounted CVMFS

					- demo

					</textarea>
				</section>

				<section data-markdown>
					<textarea data-template>
					## Questions, please!


					QR code to slides
					- contacts
					</textarea>
				</section>

				<section data-markdown>
					<textarea data-template>
					## References

					(Not for actual presentation)

					autkin demos: https://forge.autkin.net/autkin/cvmfs-fosdem26-demos
					</textarea>
				</section>
			</div>
		</div>

		<script src="dist/reveal.js"></script>
		<script src="plugin/notes/notes.js"></script>
		<script src="plugin/markdown/markdown.js"></script>
		<script src="plugin/highlight/highlight.js"></script>
		<script src="js/asciinema-player.min.js"></script>
		<script>
			// More info about initialization & config:
			// - https://revealjs.com/initialization/
			// - https://revealjs.com/config/
			Reveal.initialize({
				hash: true,

				// Learn about plugins: https://revealjs.com/plugins/
				plugins: [ RevealMarkdown, RevealHighlight, RevealNotes ]
			});
			// https://github.com/mickaelbaron/revealasciinema/blob/master/workaround.html
			// https://discourse.asciinema.org/t/asciinema-reveal-js-display-issue/618/3
			/*
			{
				const asciinemas = document.getElementsByClassName("asciinema");
				for (let i = 0; i < asciinemas.length; i++) {
					const img = document.createElement("img");
					img.setAttribute("src", "assets/img/asciinema-player-icon.svg");
					asciinemas[i].appendChild(img);
				}
			}
			*/
			function checkForCasts(event) {
				const asciinema =
					event.currentSlide.getElementsByClassName("asciinema")[0];
				if (asciinema) {
					const filename = asciinema.getAttribute("file");
					if (asciinema && !asciinema.playerObject) {
						// Remove image
						const firstelementChild = asciinema.firstElementChild;
						if (firstelementChild) {
							asciinema.firstElementChild.remove();
						}

						asciinema.playerObject = AsciinemaPlayer.create(
							filename,
							asciinema,
							{ fit: "none" }
						);
					}
				}
			}
			Reveal.on("ready", checkForCasts);
			Reveal.on("slidechanged", checkForCasts);
		</script>
	</body>
</html>
